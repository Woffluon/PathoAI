# Prometheus alert rules for PathoAI monitoring
# These rules define alerts for critical system conditions

groups:
  - name: pathoai_alerts
    interval: 30s
    rules:
      # Alert when error rate exceeds 5% over 5 minutes
      - alert: HighErrorRate
        expr: |
          (
            rate(pathoai_errors_total[5m])
            /
            rate(pathoai_requests_total[5m])
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          component: pathoai
        annotations:
          summary: "High error rate detected in PathoAI"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%) for the last 5 minutes."

      # Alert when p95 inference latency exceeds 5 seconds
      - alert: HighInferenceLatency
        expr: |
          histogram_quantile(0.95,
            rate(pathoai_inference_seconds_bucket[5m])
          ) > 5
        for: 5m
        labels:
          severity: warning
          component: pathoai
        annotations:
          summary: "High inference latency detected in PathoAI"
          description: "P95 inference latency is {{ $value | humanizeDuration }} (threshold: 5s) for model {{ $labels.model_type }}."

      # Alert when memory usage exceeds 80% of 2GB (1.6GB)
      - alert: HighMemoryUsage
        expr: pathoai_memory_bytes > 1717986918
        for: 5m
        labels:
          severity: warning
          component: pathoai
        annotations:
          summary: "High memory usage detected in PathoAI"
          description: "Memory usage is {{ $value | humanize1024 }}B (threshold: 80% of 2GB)."

      # Alert when no requests have been processed in the last 10 minutes (service might be down)
      - alert: NoRequestsProcessed
        expr: |
          rate(pathoai_requests_total[10m]) == 0
        for: 10m
        labels:
          severity: critical
          component: pathoai
        annotations:
          summary: "No requests processed by PathoAI"
          description: "PathoAI has not processed any requests in the last 10 minutes. Service may be down."

      # Alert when inference duration histogram has no data (models might not be loaded)
      - alert: NoInferenceActivity
        expr: |
          absent(pathoai_inference_seconds_count) or
          rate(pathoai_inference_seconds_count[10m]) == 0
        for: 10m
        labels:
          severity: warning
          component: pathoai
        annotations:
          summary: "No inference activity detected in PathoAI"
          description: "No inference operations have been performed in the last 10 minutes. Models may not be loaded or service is idle."
